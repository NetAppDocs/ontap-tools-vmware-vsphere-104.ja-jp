---
permalink: upgrade/upgrade-ontap-tools.html 
sidebar: sidebar 
keywords: upgrade 
summary: アップグレードは、HA 展開と非 HA 展開の両方でサポートされます。 
---
= ONTAP tools for VMware vSphereから 10.4 へのアップグレード
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
ONTAP tools for VMware vSphereから 10.4 にアップグレードできます。ただし、 ONTAPツール 10.0 または 10.1 から 10.4 への直接アップグレードはサポートされていません。

注：

* ASA r2 システムでは、ストレージ可用性ゾーン (SAZ) を追加する前に、 ONTAP 9.16.1 を搭載したONTAP tools for VMware vSphereにアップグレードする必要があります。
* ONTAP tools for VMware vSphereから 10.4 リリースへのアップグレードが失敗した場合、ロールバックはサポートされません。セットアップをリカバリするには、 ONTAP tools for VMware vSphereの RPO と、 ONTAP tools for VMware vSphereのほぼゼロ RPO またはスナップショット リカバリを使用します。


.開始する前に
非 HA アップグレードの場合はONTAPツール VM の電源をオフにし、HA アップグレードの場合はONTAPツール管理ノードの電源をオフにしてから、仮想マシン (VM) 設定に次の変更を加えます。

ONTAP tools for VMware vSphereからアップグレードする場合は、アップグレードタスクを進める前に次の手順を完了する必要があります。* サービスデータは仮想マシンにローカルに保存されるため、各ノードに 100 GB のハードディスクを追加します。* パワーオフ状態の仮想マシンの CPU とメモリを、デプロイメントの種類に応じて変更します。CPUと RAM のホットプラグインを有効にします。

+

|===
| 展開タイプ | ノードあたりのCPU（コア） | ノードあたりのメモリ(GB) | ノードあたりのディスク容量(GB) | 合計CPU(コア) | メモリ(GB) | 合計ディスク容量(GB) 


| 非HA小 | 9 | 18 | 350 | 9 | 18 | 350 


| 非HA培地 | 13 | 26 | 350 | 13 | 26 | 350 


| HAスモール | 9 | 18 | 350 | 27 | 54 | 1050 


| HAミディアム | 13 | 26 | 350 | 39 | 78 | 1050 


| HAラージ | 17 | 34 | 350 | 51 | 102 | 1050 
|===
* 変更が完了したら、VM の電源をオンにし、サービスが実行状態になるまで待ちます。
* HA 展開の場合は、リソースを変更し、CPU と RAM のホット プラグインを有効にし、2 番目と 3 番目のノードにも 100 GB のハード ディスクを追加します。これらのノードを再起動する必要はありません。
* アプライアンスがONTAPツール 10.2 を使用してローカル パス (簡単な導入) として導入された場合は、アップグレードする前に静止スナップショットを取得する必要があります。


ONTAP tools for VMware vSphere 10.0から10.1にアップグレードする場合は、アップグレードタスクを続行する前に次の手順を完了する必要があります: *診断を有効にする*

. vCenter Server から、 ONTAPツールへのコンソールを開きます。
. メンテナンス ユーザとしてログインします。
. *4* と入力して *サポートと診断* を選択します。
. *2* と入力して *リモート診断アクセスを有効にする* を選択します。
. 希望するパスワードを設定するには、「*y*」と入力します。
. ユーザー名を「diag」、パスワードを前の手順で設定した状態で、ターミナル/PuTTY から VM IP アドレスにログインします。


*MongoDBのバックアップを取る*

MongoDB のバックアップを取得するには、次のコマンドを実行します。

* kn exec -it ntv-mongodb-0 sh - kn は kubectl -n ntv-system のエイリアスです。
* ポッド内で _env | grep MONGODB_ROOT_PASSWORD_ コマンドを実行します。
* ポッドから抜け出すには、_exit_ コマンドを実行します。
* _kn exec ntv-mongodb-0 --mongodump -u root -p MONGODB_ROOT_PASSWORD --archive=/tmp/mongodb-backup.gz --gzip_ コマンドを実行して、上記のコマンドで設定した MONGO_ROOT_PASSWORD を置き換えます。
* _kn cp ntv-mongodb-0:/tmp/mongodb-backup.gz ./mongodb-backup.gz_ コマンドを実行して、上記のコマンドを使用して作成された mongodb バックアップをポッドからホストにコピーします。


*すべてのボリュームの準スナップショットを撮ります*

* 「kn get pvc」コマンドを実行し、コマンド出力を保存します。
* 次のいずれかの方法を使用して、すべてのボリュームのスナップショットを 1 つずつ作成します。
+
** CLIから、コマンド_volume snapshot create -vserver <vserver_name> -volume <volume_name> -snapshot <snapshot_name>_を実行します。
** ONTAP System Manager ユーザー インターフェイスから、検索バーでボリュームを名前で検索し、名前を選択してそのボリュームを開きます。スナップショットに移動し、そのボリュームのスナップショットを追加します。




*vCenter 内のONTAP tools for VMware vSphereのスナップショットを取得します (HA 展開の場合は 3 台の VM、非 HA 展開の場合は 1 台の VM)*

* vSphere クライアント ユーザー インターフェイスで、VM を選択します。
* スナップショットタブに移動し、*スナップショットを撮る*ボタンを選択します。 VM の静止スナップショットを取得します。参照 https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/take-snapshots-of-a-virtual-machine.html["仮想マシンのスナップショットを作成する"^]詳細については。


アップグレードを実行する前に、プレフィックスが「generate-support-bundle-job」であるログ バンドルから完了したポッドを削除します。サポート バンドルの生成が進行中の場合は、完了するまで待ってからポッドを削除します。

どのようなタイプのアップグレードでも、100 GB のハード ディスク ドライブ (HDD) を追加する必要があります。  HDD を追加するには、次のタスクを実行します。

. 単一ノード構成の VM を選択するか、HA 構成の 3 つの VM すべてを選択します。
. VMを右クリックし、[新しいデバイスの追加] > [ハードディスク]を選択します。
. *新しいハードディスク* フィールドに 100 GB の HDD を追加します。
. *適用*を選択


ハードディスクを追加した後、それぞれの構成に合わせて VM のリソースを更新し、プライマリ VM を再起動します。

新しいHDDが作成されます。動的ストレージ プロビジョナーは、この HDD を使用してボリュームを生成または複製します。

.手順
. ONTAP tools for VMware vSphereをコンテンツ ライブラリにアップロードします。
. プライマリ VM ページで、[*アクション*] > [*設定の編集*] を選択します。プライマリ VM 名を識別するには:
+
.. 任意のノードで診断シェルを有効にする
.. 次のコマンドを実行します。
`grep sourceHost /opt/netapp/meta/ansible_vars.yaml`


. *CD/DVD ドライブ* フィールドの編集設定ウィンドウで、コンテンツ ライブラリの ISO ファイルを選択します。
. ISO ファイルを選択し、[*OK*] を選択します。  *CD/DVD ドライブ* フィールドで接続されているチェックボックスを選択します。image:../media/primaryvm-edit-settings.png["設定を編集する"]
. vCenter Server から、 ONTAPツールへのコンソールを開きます。
. メンテナンス ユーザとしてログインします。
. *2* と入力して、システム構成メニューを選択します。
. アップグレード オプションを選択するには、「*7*」と入力します。
. アップグレードすると、次のアクションが自動的に実行されます。
+
.. 証明書のアップグレード
.. リモートプラグインアップグレード




ONTAP tools for VMware vSphereにアップグレードすると、次のことが可能になります。

* マネージャーのユーザーインターフェースからサービスを無効にします
* 非HA設定からHA設定に移行する
* 非 HA の小規模構成を非 HA の中規模構成にスケールアップするか、または HA の中規模または大規模構成にスケールアップします。
* HA 以外のアップグレードの場合は、変更を反映するためにONTAPツール VM を再起動します。HA アップグレードの場合は、 ONTAPツール管理ノードを再起動して、ノードの変更を反映します。


.次の手順
ONTAP tools for VMware vSphereの以前のリリースから 10.4 にアップグレードした後、SRA アダプタを再スキャンして、VMware Live Site Recovery のストレージ レプリケーション アダプタ ページで詳細が更新されていることを確認します。

アップグレードが正常に完了したら、次の手順に従って、 ONTAPからTridentボリュームを手動で削除します。


NOTE: ONTAP tools for VMware vSphereが非 HA の小規模または中規模 (ローカル パス) 構成であった場合、これらの手順は必要ありません。

. vCenter Server から、 ONTAPツールへのコンソールを開きます。
. メンテナンス ユーザとしてログインします。
. *4* と入力して、*サポートと診断* メニューを選択します。
. *1* と入力して、*診断シェルにアクセス* オプションを選択します。
. 次のコマンドを実行します
+
[listing]
----
sudo python3 /home/maint/scripts/ontap_cleanup.py
----
. ONTAPのユーザー名とパスワードを入力してください


これにより、ONTAP tools for VMware vSphereで使用されるONTAP内のすべてのTridentボリュームが削除されます。

.関連情報
link:../migrate/migrate-to-latest-ontaptools.html["ONTAP tools for VMware vSphereから 10.4 に移行する"]
